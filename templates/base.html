<!doctype html>
<html lang="es">
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <title>{% block title %}Panel · Repair-Cell{% endblock %}</title>

  <!-- Bootstrap 5 + Icons -->
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet" crossorigin="anonymous">
  <link href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.3/font/bootstrap-icons.css" rel="stylesheet">
  <link rel="stylesheet" href="{{ url_for('static', filename='styles.css') }}">
</head>
<body class="bg-light">

  <!-- Navbar -->
  <nav class="navbar navbar-expand-lg bg-white shadow-sm sticky-top">
    <div class="container">
      <a class="navbar-brand fw-semibold d-flex align-items-center" href="{{ url_for('index') }}">
        <i class="bi bi-wrench-adjustable-circle me-2"></i> Repair-Cell
      </a>

      <button class="navbar-toggler" type="button" data-bs-toggle="offcanvas" data-bs-target="#mainMenu"
              aria-controls="mainMenu" aria-label="Abrir menú">
        <span class="navbar-toggler-icon"></span>
      </button>

      <div class="offcanvas offcanvas-end" tabindex="-1" id="mainMenu" aria-labelledby="mainMenuLabel">
        <div class="offcanvas-header">
          <h5 class="offcanvas-title" id="mainMenuLabel">Menú</h5>
          <button type="button" class="btn-close" data-bs-dismiss="offcanvas" aria-label="Cerrar"></button>
        </div>

        <div class="offcanvas-body">
          <ul class="navbar-nav me-auto">
            <li class="nav-item">
              <a class="nav-link" href="{{ url_for('index') }}"><i class="bi bi-house-door me-1"></i>Inicio</a>
            </li>

            {% if has_role('administrador') or has_role('facturador') %}
              <!-- Órdenes -->
              <li class="nav-item">
                <a class="nav-link" href="{{ url_for('orden.nueva') }}"><i class="bi bi-clipboard-plus me-1"></i>Órdenes</a>
              </li>

              <!-- Facturación: abre modal -->
              <li class="nav-item">
                <a class="nav-link" href="#" data-bs-toggle="modal" data-bs-target="#facturarModal">
                  <i class="bi bi-receipt me-1"></i>Facturación
                </a>
              </li>
            {% endif %}

            {% if has_role('administrador') %}
              <!-- Administración -->
              <li class="nav-item">
                <a class="nav-link" href="{{ url_for('admin.panel') }}">
                  <i class="bi bi-people-gear me-1"></i>Administración
                </a>
              </li>

              <!-- Catálogos -->
              <li class="nav-item dropdown">
                <a class="nav-link dropdown-toggle" href="#" role="button" data-bs-toggle="dropdown">
                  <i class="bi bi-boxes me-1"></i>Catálogos
                </a>
                <ul class="dropdown-menu">
                  <li><a class="dropdown-item" href="{{ url_for('cliente.form') }}"><i class="bi bi-people me-1"></i>Clientes</a></li>
                  <li><a class="dropdown-item" href="{{ url_for('repuesto.form') }}"><i class="bi bi-cpu me-1"></i>Repuestos</a></li>
                  <li><a class="dropdown-item" href="{{ url_for('cat_servicio.form') }}"><i class="bi bi-tools me-1"></i>Servicios</a></li>
                </ul>
              </li>
            {% endif %}
          </ul>

          <!-- Lado derecho: sesión -->
          <ul class="navbar-nav ms-auto align-items-lg-center">
            {% if current_user.is_authenticated %}
              <li class="nav-item dropdown">
                <a class="nav-link dropdown-toggle d-flex align-items-center" href="#" role="button" data-bs-toggle="dropdown">
                  <i class="bi bi-person-circle fs-5 me-2"></i>
                  <span class="d-none d-lg-inline">{{ current_user.usuario_login }}</span>
                </a>
                <ul class="dropdown-menu dropdown-menu-end">
                  <li class="px-3 py-2">
                    <div class="small text-muted">Usuario</div>
                    <div class="fw-semibold">{{ current_user.usuario_login }}</div>
                    {% if g.user_roles %}
                      <div class="mt-2 small">
                        <span class="text-muted">Roles:</span>
                        {% for r in g.user_roles %}
                          <span class="badge text-bg-light border">{{ r }}</span>
                        {% endfor %}
                      </div>
                    {% endif %}
                  </li>
                  <li><hr class="dropdown-divider"></li>
                  <li class="px-3 py-2">
                    <form method="post" action="{{ url_for('auth.logout') }}">
                      <button class="btn btn-outline-danger w-100">
                        <i class="bi bi-box-arrow-right me-1"></i>Salir
                      </button>
                    </form>
                  </li>
                </ul>
              </li>
            {% else %}
              <li class="nav-item">
                <a class="btn btn-outline-primary me-2" href="{{ url_for('auth.login_form') }}">
                  <i class="bi bi-box-arrow-in-right me-1"></i>Acceder
                </a>
              </li>
              <li class="nav-item">
                <a class="btn btn-primary" href="{{ url_for('registro.form') }}">
                  <i class="bi bi-person-plus me-1"></i>Registrarse
                </a>
              </li>
            {% endif %}
          </ul>
        </div>
      </div>
    </div>
  </nav>

  <!-- Flash + contenido -->
  <main class="container py-4 py-md-5">
    {% with msgs = get_flashed_messages(with_categories=true) %}
      {% if msgs %}
        <div class="mb-3">
          {% for cat, m in msgs %}
            <div class="alert alert-{{ 'info' if cat not in ['primary','secondary','success','danger','warning','info','light','dark'] else cat }} alert-dismissible fade show" role="alert">
              {{ m }}
              <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Cerrar"></button>
            </div>
          {% endfor %}
        </div>
      {% endif %}
    {% endwith %}

    {% block content %}{% endblock %}
  </main>

  <!-- Footer -->
  <footer class="mt-auto border-top bg-white">
    <div class="container py-4">
      <div class="row g-3 align-items-center">
        <div class="col-12 col-md">
          <div class="d-flex align-items-center text-muted small">
            <i class="bi bi-wrench me-2"></i>
            <span>© {{ 2025 }} Repair-Cell. Todos los derechos reservados.</span>
          </div>
        </div>
        <div class="col-12 col-md-auto">
          <ul class="nav">
            <li class="nav-item"><a class="nav-link px-2 text-muted" href="#"><i class="bi bi-shield-lock me-1"></i>Privacidad</a></li>
            <li class="nav-item"><a class="nav-link px-2 text-muted" href="#"><i class="bi bi-file-earmark-text me-1"></i>Términos</a></li>
            <li class="nav-item"><a class="nav-link px-2 text-muted" href="#"><i class="bi bi-envelope me-1"></i>Soporte</a></li>
          </ul>
        </div>
        <div class="col-12 col-md-auto">
          <div class="d-flex gap-3">
            <a class="text-muted" href="#" aria-label="Facebook"><i class="bi bi-facebook fs-5"></i></a>
            <a class="text-muted" href="#" aria-label="WhatsApp"><i class="bi bi-whatsapp fs-5"></i></a>
            <a class="text-muted" href="#" aria-label="GitHub"><i class="bi bi-github fs-5"></i></a>
          </div>
        </div>
      </div>
    </div>
  </footer>

  <!-- Modal: Facturar por N° de Orden -->
  <div class="modal fade" id="facturarModal" tabindex="-1" aria-hidden="true">
    <div class="modal-dialog">
      <form class="modal-content" onsubmit="redirFacturar(event)">
        <div class="modal-header">
          <h5 class="modal-title"><i class="bi bi-receipt me-2"></i>Ir a facturar</h5>
          <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Cerrar"></button>
        </div>
        <div class="modal-body">
          <label class="form-label">N° de Orden</label>
          <input id="fact-orden" type="number" min="1" class="form-control" placeholder="Ej. 123" required>
          <div class="form-text">Ingresa el número de la Orden de Trabajo lista para facturar.</div>
        </div>
        <div class="modal-footer">
          <button class="btn btn-primary"><i class="bi bi-arrow-right-circle me-1"></i>Continuar</button>
        </div>
      </form>
    </div>
  </div>

  <!-- Bootstrap JS -->
  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js" crossorigin="anonymous"></script>

  <script>
    function redirFacturar(ev){
      ev.preventDefault();
      const id = document.getElementById('fact-orden').value.trim();
      if(!id) return;
      window.location.href = `/facturacion/emitir/${encodeURIComponent(id)}`;
    }
  </script>
</body>
</html>

