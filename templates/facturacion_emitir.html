{% extends "base.html" %}
{% block title %}Emitir factura{% endblock %}
{% block content %}
<h4 class="mb-3">Factura · OT #{{ ot.id_orden }}</h4>

<div class="row g-3">
  <div class="col-md-6">
    <div class="card shadow-sm">
      <div class="card-body">
        <h6 class="text-muted">Cliente</h6>
        <div class="fw-semibold">{{ ot.cli_nombre }}</div>
        <div class="small text-muted">CI/RUC: {{ ot.cli_cedula or '—' }}</div>
        <div class="small text-muted">Tel: {{ ot.cli_tel or '—' }} · Email: {{ ot.cli_email or '—' }}</div>
      </div>
    </div>
  </div>
  <div class="col-md-6">
    <div class="card shadow-sm">
      <div class="card-body">
        <h6 class="text-muted">Orden</h6>
        <div>Estado: <span class="badge text-bg-light border">{{ ot.estado }}</span></div>
        <div class="small text-muted">Creada: {{ ot.creado_en }}</div>
      </div>
    </div>
  </div>
</div>

<div class="card shadow-sm mt-3">
  <div class="card-body">
    <h6 class="mb-3">Conceptos</h6>
    <div class="table-responsive">
      <table class="table table-sm align-middle">
        <thead><tr><th>Tipo</th><th>Descripción</th><th class="text-end">Cant</th><th class="text-end">P.Unit</th><th class="text-end">Importe</th></tr></thead>
        <tbody>
        {% for it in items %}
          <tr>
            <td>{{ it.tipo }}</td>
            <td>{{ it.descripcion }}</td>
            <td class="text-end">{{ '%.2f'|format(it.cantidad) }}</td>
            <td class="text-end">{{ '%.2f'|format(it.precio_unitario) }}</td>
            <td class="text-end">{{ '%.2f'|format(it.cantidad * it.precio_unitario) }}</td>
          </tr>
        {% else %}
          <tr><td colspan="5" class="text-center text-muted">Sin conceptos.</td></tr>
        {% endfor %}
        </tbody>
      </table>
    </div>

    <div class="row g-3 mt-3">
      <div class="col-md">
        <h6>Abonos</h6>
        <ul class="list-group list-group-flush">
          {% for a in abonos %}
          <li class="list-group-item d-flex justify-content-between">
            <span>{{ a.creado_en }} · {{ a.usuario_login or '—' }}</span>
            <span class="fw-semibold">{{ '%.2f'|format(a.monto) }}</span>
          </li>
          {% else %}
          <li class="list-group-item text-muted">No hay abonos.</li>
          {% endfor %}
        </ul>
      </div>
      <div class="col-md">
        <h6>Totales</h6>
        <div class="d-flex justify-content-between"><span>Subtotal</span><span class="fw-semibold">{{ '%.2f'|format(subtotal) }}</span></div>
        <div class="d-flex justify-content-between"><span>Pagado</span><span class="fw-semibold text-success">- {{ '%.2f'|format(pagado) }}</span></div>
        <div class="d-flex justify-content-between"><span>IVA ({{ config.get('IVA_PORCENTAJE', 15) }}%)</span><span class="fw-semibold">{{ '%.2f'|format(iva) }}</span></div>
        <hr class="my-2">
        <div class="d-flex justify-content-between fs-5"><span>Total a cobrar</span><span class="fw-bold">{{ '%.2f'|format(total) }}</span></div>
      </div>
    </div>

    <form class="mt-4" method="post" action="{{ url_for('facturacion.emitir_post', id_orden=ot.id_orden) }}">
      <button class="btn btn-primary">
        <i class="bi bi-printer me-1"></i> Emitir factura
      </button>
      <a class="btn btn-outline-secondary ms-2" href="{{ url_for('index') }}">Cancelar</a>
    </form>
  </div>
</div>
{% endblock %}
