{% extends "base.html" %}
{% block title %}Facturación · OT #{{ ot.id_orden }}{% endblock %}
{% block content %}

<div class="mb-4">
  <h3 class="fw-bold">Facturar Orden #{{ ot.id_orden }}</h3>
  <p class="text-muted mb-1">
    Agrega servicios y/o repuestos desde los combos. Los abonos se descuentan automáticamente.
  </p>
</div>

<!-- Cabecera -->
<div class="card shadow-sm mb-4">
  <div class="card-body">
    <div class="row g-3">
      <div class="col-md-6">
        <h6 class="text-muted mb-1">Cliente</h6>
        <div class="fw-semibold">{{ ot.cli_nombre }}</div>
        <div class="small text-muted">
          ID: {{ ot.cli_identificacion or '—' }} · Tel: {{ ot.cli_tel or '—' }} · Email: {{ ot.cli_email or '—' }}
        </div>
      </div>
      <div class="col-md-6">
        <h6 class="text-muted mb-1">Orden</h6>
        <div>Estado: <span class="badge bg-secondary">{{ ot.estado or '—' }}</span></div>
        <div class="small text-muted">
          Recibida: {{ (ot.fecha_recepcion or ot.creado_en) | string }}
        </div>
      </div>
    </div>
  </div>
</div>

<!-- Agregar servicio -->
<div class="card shadow-sm mb-4">
  <div class="card-body">
    <h5 class="card-title mb-3">Agregar servicio</h5>
    <form class="row g-2" method="post" action="{{ url_for('facturacion.agregar_servicio', id_orden=ot.id_orden) }}">
      <div class="col-md-6">
        <label class="form-label">Servicio (catálogo)</label>
        <select id="srv_id" name="srv_id" class="form-select">
          <option value="">-- Selecciona --</option>
          {% for s in cat_serv %}
          <option value="{{ s.id }}" data-precio="{{ s.p }}" data-desc="{{ s.d }}">{{ s.d }} ({{ '%.2f'|format(s.p|float) }})</option>
          {% endfor %}
        </select>
      </div>
      <div class="col-md-6">
        <label class="form-label">Descripción (editable)</label>
        <input id="srv_desc" name="srv_desc" class="form-control" placeholder="Ej. Reparación de placa">
      </div>
      <div class="col-md-3">
        <label class="form-label">Cantidad</label>
        <input id="srv_cant" name="srv_cant" type="number" step="any" min="1" value="1" class="form-control">
      </div>
      <div class="col-md-3">
        <label class="form-label">Precio unitario</label>
        <input id="srv_precio" name="srv_precio" type="number" step="any" min="0" value="0" class="form-control">
      </div>
      <div class="col-md-3 align-self-end">
        <button class="btn btn-primary w-100"><i class="bi bi-plus-circle me-1"></i>Agregar servicio</button>
      </div>
    </form>
  </div>
</div>

<!-- Agregar repuesto -->
<div class="card shadow-sm mb-4">
  <div class="card-body">
    <h5 class="card-title mb-3">Agregar repuesto</h5>
    <form class="row g-2" method="post" action="{{ url_for('facturacion.agregar_repuesto', id_orden=ot.id_orden) }}">
      <div class="col-md-6">
        <label class="form-label">Repuesto (catálogo)</label>
        <select id="rep_id" name="rep_id" class="form-select">
          <option value="">-- Selecciona --</option>
          {% for r in cat_rep %}
          <option value="{{ r.id }}" data-precio="{{ r.p }}" data-desc="{{ r.d }}">{{ r.d }} ({{ '%.2f'|format(r.p|float) }})</option>
          {% endfor %}
        </select>
      </div>
      <div class="col-md-6">
        <label class="form-label">Descripción (editable)</label>
        <input id="rep_desc" name="rep_desc" class="form-control" placeholder="Ej. Pantalla genérica">
      </div>
      <div class="col-md-3">
        <label class="form-label">Cantidad</label>
        <input id="rep_cant" name="rep_cant" type="number" step="any" min="1" value="1" class="form-control">
      </div>
      <div class="col-md-3">
        <label class="form-label">Precio unitario</label>
        <input id="rep_precio" name="rep_precio" type="number" step="any" min="0" value="0" class="form-control">
      </div>
      <div class="col-md-3 align-self-end">
        <button class="btn btn-primary w-100"><i class="bi bi-plus-circle me-1"></i>Agregar repuesto</button>
      </div>
    </form>
  </div>
</div>

<!-- Detalles actuales -->
<div class="card shadow-sm mb-4">
  <div class="card-body">
    <h5 class="card-title mb-3">Detalle de ítems</h5>

    {% if no_servicios and no_repuestos %}
      <div class="alert alert-warning mb-0">Esta orden no tiene ítems cargados.</div>
    {% else %}
      {% if not no_servicios %}
        <h6>Servicios</h6>
        <div class="table-responsive mb-3">
          <table class="table table-sm align-middle">
            <thead><tr><th>Descripción</th><th class="text-end">Cant.</th><th class="text-end">P. Unit</th><th class="text-end">Importe</th></tr></thead>
            <tbody>
              {% for s in servicios %}
              <tr>
                <td>{{ s.descripcion }}</td>
                <td class="text-end">{{ s.cantidad }}</td>
                <td class="text-end">{{ '%.2f'|format(s.precio_unitario|float) }}</td>
                <td class="text-end">{{ '%.2f'|format((s.cantidad|float)*(s.precio_unitario|float)) }}</td>
              </tr>
              {% endfor %}
            </tbody>
            <tfoot>
              <tr><th colspan="3" class="text-end">Subtotal servicios</th><th class="text-end">{{ '%.2f'|format(subtotal_servicios) }}</th></tr>
            </tfoot>
          </table>
        </div>
      {% endif %}

      {% if not no_repuestos %}
        <h6>Repuestos</h6>
        <div class="table-responsive">
          <table class="table table-sm align-middle">
            <thead><tr><th>Descripción</th><th class="text-end">Cant.</th><th class="text-end">P. Unit</th><th class="text-end">Importe</th></tr></thead>
            <tbody>
              {% for r in repuestos %}
              <tr>
                <td>{{ r.descripcion }}</td>
                <td class="text-end">{{ r.cantidad }}</td>
                <td class="text-end">{{ '%.2f'|format(r.precio_unitario|float) }}</td>
                <td class="text-end">{{ '%.2f'|format((r.cantidad|float)*(r.precio_unitario|float)) }}</td>
              </tr>
              {% endfor %}
            </tbody>
            <tfoot>
              <tr><th colspan="3" class="text-end">Subtotal repuestos</th><th class="text-end">{{ '%.2f'|format(subtotal_repuestos) }}</th></tr>
            </tfoot>
          </table>
        </div>
      {% endif %}
    {% endif %}
  </div>
</div>

<!-- Abonos -->
<div class="card shadow-sm mb-4">
  <div class="card-body">
    <h5 class="card-title mb-3">Abonos</h5>
    {% if no_abonos %}
      <div class="text-muted">No hay abonos registrados.</div>
    {% else %}
      <div class="table-responsive">
        <table class="table table-sm">
          <thead><tr><th>Fecha</th><th>Método</th><th class="text-end">Monto</th></tr></thead>
          <tbody>
            {% for a in abonos %}
            <tr>
              <td>{{ a.fecha }}</td>
              <td>{{ a.metodo or '—' }}</td>
              <td class="text-end">{{ '%.2f'|format(a.monto|float) }}</td>
            </tr>
            {% endfor %}
          </tbody>
          <tfoot>
            <tr><th colspan="2" class="text-end">Total abonado</th><th class="text-end">{{ '%.2f'|format(pagado) }}</th></tr>
          </tfoot>
        </table>
      </div>
    {% endif %}
  </div>
</div>

<!-- Totales + Facturar -->
<div class="card shadow-sm">
  <div class="card-body">
    <h5 class="card-title mb-3">Totales</h5>
    <div class="row g-3">
      <div class="col-md-6">
        <ul class="list-group list-group-flush">
          <li class="list-group-item d-flex justify-content-between"><span>Subtotal</span><strong>{{ '%.2f'|format(subtotal) }}</strong></li>
          <li class="list-group-item d-flex justify-content-between"><span>Abonos</span><strong>- {{ '%.2f'|format(pagado) }}</strong></li>
          <li class="list-group-item d-flex justify-content-between"><span>IVA {{ iva_pct }}%</span><strong>{{ '%.2f'|format(iva) }}</strong></li>
          <li class="list-group-item d-flex justify-content-between"><span>Total a cobrar</span><strong class="fs-5">{{ '%.2f'|format(total) }}</strong></li>
        </ul>
      </div>
      <div class="col-md-6 d-flex align-items-end justify-content-md-end">
        <form method="post" action="{{ url_for('facturacion.emitir_post', id_orden=ot.id_orden) }}">
          <button class="btn btn-primary btn-lg" {% if no_servicios and no_repuestos %}disabled{% endif %}>
            <i class="bi bi-receipt me-1"></i> Facturar todo
          </button>
          <a class="btn btn-outline-secondary btn-lg ms-2" href="{{ url_for('index') }}">Cancelar</a>
        </form>
      </div>
    </div>
  </div>
</div>

<script>
  // Autocompleta descripción y precio desde el combo
  const srvSel = document.getElementById('srv_id');
  const srvDesc= document.getElementById('srv_desc');
  const srvPrec= document.getElementById('srv_precio');
  if(srvSel){
    srvSel.addEventListener('change', e=>{
      const opt = srvSel.selectedOptions[0];
      if(!opt) return;
      const d = opt.getAttribute('data-desc');
      const p = opt.getAttribute('data-precio');
      if(d) srvDesc.value = d;
      if(p) srvPrec.value = p;
    });
  }
  const repSel = document.getElementById('rep_id');
  const repDesc= document.getElementById('rep_desc');
  const repPrec= document.getElementById('rep_precio');
  if(repSel){
    repSel.addEventListener('change', e=>{
      const opt = repSel.selectedOptions[0];
      if(!opt) return;
      const d = opt.getAttribute('data-desc');
      const p = opt.getAttribute('data-precio');
      if(d) repDesc.value = d;
      if(p) repPrec.value = p;
    });
  }
</script>

{% endblock %}
