{% extends "base.html" %}
{% block title %}OT #{{ ot.id_orden }}{% endblock %}
{% block content %}
<style>
  @media print{
    .d-print-none{ display:none !important; }
    .card{ box-shadow:none !important; border:0 !important; }
  }
</style>

<div class="card shadow-sm">
  <div class="card-body">
    <div class="d-flex justify-content-between align-items-start">
      <div>
        <h4 class="mb-0">Orden de Trabajo #{{ ot.id_orden }}</h4>
        <div class="text-muted small">
          Estado: {{ ot.estado or '—' }} · Fecha: {{ ot.creado_en or '—' }}
        </div>
      </div>
      <div class="text-end">
        <div class="fw-semibold">{{ config.get('NEGOCIO_NOMBRE','Repair-Cell') }}</div>
        <div class="small text-muted">{{ config.get('NEGOCIO_DIR','') }} · {{ config.get('NEGOCIO_TEL','') }}</div>
      </div>
    </div>
    <hr>

    <div class="row">
      <div class="col-md-6">
        <h6 class="text-muted">Cliente</h6>
        <div class="fw-semibold">{{ ot.cli_nombre }}</div>
        <div class="small text-muted">
          CI/RUC: {{ ot.cli_cedula or '—' }} · Tel: {{ ot.cli_tel or '—' }} · Email: {{ ot.cli_email or '—' }}
        </div>
      </div>
      <div class="col-md-6">
        <h6 class="text-muted">Equipo</h6>
        <div>{{ ot.eq_modelo or '—' }}</div>
        <div class="small text-muted">IMEI: {{ ot.eq_imei or '—' }} · Serie: {{ ot.eq_serie or '—' }}</div>
      </div>
    </div>

    {# Descripción / observaciones de la OT (aliaseada como "descripcion") #}
    {% if ot.descripcion %}
      <h6 class="mt-3">Descripción</h6>
      <p class="mb-2">{{ ot.descripcion }}</p>
    {% endif %}

    <h6 class="mt-3">Detalles (servicios y repuestos)</h6>
    <div class="table-responsive">
      <table class="table table-sm align-middle">
        <thead>
          <tr>
            <th>Tipo</th>
            <th>Descripción</th>
            <th class="text-end">Cant</th>
            <th class="text-end">P. Unit</th>
            <th class="text-end">Importe</th>
          </tr>
        </thead>
        <tbody>
          {% for it in items %}
          <tr>
            <td>{{ it.tipo }}</td>
            <td>
              <div class="fw-semibold">{{ it.item }}</div>
              {% if it.descripcion_item %}
                <div class="small text-muted">{{ it.descripcion_item }}</div>
              {% endif %}
            </td>
            <td class="text-end">{{ '%.2f'|format(it.cantidad) }}</td>
            <td class="text-end">{{ '%.2f'|format(it.precio_unit) }}</td>
            <td class="text-end">{{ '%.2f'|format(it.subtotal) }}</td>
          </tr>
          {% else %}
          <tr><td colspan="5" class="text-center text-muted">Sin detalles registrados.</td></tr>
          {% endfor %}
        </tbody>
      </table>
    </div>

    <div class="row g-3">
      <div class="col-md">
        <h6>Abonos</h6>
        <ul class="list-group list-group-flush">
          {% for a in abonos %}
          <li class="list-group-item d-flex justify-content-between">
            <span>
              {{ a.creado_en }}
              {% if a.metodo %}<span class="text-muted small">· {{ a.metodo }}</span>{% endif %}
              {% if a.referencia %}<span class="text-muted small">· Ref: {{ a.referencia }}</span>{% endif %}
            </span>
            <span class="fw-semibold">{{ '%.2f'|format(a.monto) }}</span>
          </li>
          {% else %}
          <li class="list-group-item text-muted">No hay abonos.</li>
          {% endfor %}
        </ul>
      </div>
      <div class="col-md">
        <h6>Totales</h6>
        <div class="d-flex justify-content-between">
          <span>Subtotal</span><span class="fw-semibold">{{ '%.2f'|format(subtotal) }}</span>
        </div>
        <div class="d-flex justify-content-between">
          <span>Pagado</span><span class="fw-semibold text-success">- {{ '%.2f'|format(pagado) }}</span>
        </div>
        <hr class="my-2">
        <div class="d-flex justify-content-between fs-5">
          <span>Saldo</span><span class="fw-bold">{{ '%.2f'|format(saldo) }}</span>
        </div>
      </div>
    </div>

    <div class="mt-4 d-print-none">
      <button type="button" class="btn btn-primary" onclick="window.print()">
        <i class="bi bi-printer me-1"></i>Imprimir
      </button>
      <a class="btn btn-outline-secondary ms-2" href="{{ url_for('index') }}">Volver</a>
    </div>
  </div>
</div>

<script>
  // auto-imprimir si viene ?autoprint=1
  (function(){
    const p = new URLSearchParams(location.search);
    if (p.get('autoprint') === '1') {
      setTimeout(() => window.print(), 150);
    }
  })();
</script>
{% endblock %}
